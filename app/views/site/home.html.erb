<h2>Home Page</h2>
<div class="home-mainbar">
	<button class='btn btn-default home-events js-events'>EventsJS</button>
	<button class='home-town js-town btn btn-default'>Town</button>
	</div>

<div class="my-container-events">
<%= link_to "+Create Event", new_user_event_path(current_user), class: "create-event" %>
<div class="block block-events">
	<p class="block-header">Events</p>
		<div class="sponsored-events">
	<h4>Promoted Events</h4>
	<% @all_events.each do |an_event| %>
	<% if an_event.sponsored %>
			<div class="sponsored-event">
			<%= image_tag an_event.avatar.url(:medium), class: "sponsored-event-photo" %><br>

      <%= an_event.title %>

			</div>
		<% end %>
	<% end %>
		</div>
		<div class="not-sponsored-events">
	<% @all_events.each do |an_event| %>
	<% if an_event.sponsored == false %>
		<div class='an-event panel panel-default'>
			<div class='panel-heading'><%= an_event.title %>
			</div>
			<div class='panel-body'>
			<p>Date: <%= an_event.date_date %> </p>
			<p>Time: <%= an_event.date_time %></p>
			</div>
			</div>
	<% end %>
	<% end %>
			</div>
</div>
</div>
<div class="my-container-map block block-town" style="display: none;">
<p class="block-header">Town Map</p>
    <div id="map"></div>
    <script>
      function initMap() {
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 11
          }); 

        var script = document.createElement('script');
        script.src = '/api/users';
        document.getElementsByTagName('head')[0].appendChild(script);

        var script = document.createElement('script');
        script.src = '/api/zipcodes';
        document.getElementsByTagName('head')[0].appendChild(script);
        var usersInfo = []

        window.handleUserData = function(results) {
          for (var aUser = 0; aUser < results.length; aUser ++) {
            usersInfo.push(results[aUser]);
          }
          console.log(usersInfo);
        }


        window.zipContainingUsers = function(results) {
          for (var i = 0; i < results.length; i ++) {
            $.ajax({
              type: "GET",
              url: `http://maps.googleapis.com/maps/api/geocode/json?address=${results[i]}&sensor=false`,
              success: goToFunction,
              error: handleError
            })
            
            
            function goToFunction(response) {
              console.log(response) 
              var theCircle = new google.maps.Circle({
                path: google.maps.SymbolPath.CIRCLE,
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.35,
                map: map,
                center: response.results[0].geometry.location,
                radius: 100
              });
         attachUsers(theCircle, usersInfo, response.results[0].address_components[0].long_name, response.results[0].geometry.location);
            }

          }  
        }

        function attachUsers(theIcon, userInfo, zip, latlong) {
         
           var usersWithSameZip = [];

           userInfo.forEach(function(element){
              if (zip === element.zipcode)
                usersWithSameZip.push(element)
            });

           // for (i = 0; i < usersWithSameZip.length; i++ ) {
             
           //    var person[i] = `<div><p>Name: ${usersWithSameZip[i].first_name}</p><p>Cell: ${usersWithSameZip[i].phone}`
           //    i++ 
           //  }

            
          
          // console.log(nameAndNumber)

          var infowindow = new google.maps.InfoWindow({
            content:  nameAndNumber(usersWithSameZip),
            position: latlong
            });
            theIcon.addListener('click', function() {
            infowindow.open(theIcon.get('map'), theIcon);
        });
          
          }
        
 
        if (navigator.geolocation) {
        	navigator.geolocation.getCurrentPosition(function(position) {
        		var pos = {
        			lat: position.coords.latitude,
        			lng: position.coords.longitude
        		};

        		
        		map.setCenter(pos);
        		var geoloccontrol = new klokantech.GeolocationControl(map);

        	}, function() {
         		var infoWindow = new google.maps.InfoWindow({map: map});
        		handleLocationError(true, infoWindow, map.getCenter());
        	});
        } else {
        	handleLocationError(false, infoWindow, map.getCenter());
        }
    }
   	function handleLocationError(browserHasGeolocation, infoWindow, pos) {
  infoWindow.setPosition(pos);
  infoWindow.setContent(browserHasGeolocation ?
                        'Error: The Geolocation service failed.' :
                        'Error: Your browser doesn\'t support geolocation.');
}	
      
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBJxV3P8qo_tH94oXeRWJt17e9ycePwjYw&callback=initMap">
    </script>
</div>